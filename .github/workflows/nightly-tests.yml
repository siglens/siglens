name: Nightly-Tests

on:
  schedule:
    - cron: '0 5 * * *'  # Runs every day at midnight EST (UTC-5)
  workflow_dispatch:  # Allows manual trigger as well

jobs:
  Clickbench-10M-Test:
    runs-on: [self-hosted, Linux, X64]
    name: Clickbench 10M
    steps:
      - uses: actions/setup-go@v3
        with:
          go-version: 1.19
      - name: Install dependencies
        run: |
          sudo yum install python3-pip
          pip install requests
      - uses: actions/checkout@v3
      - name: Build Siglens
        run: make build
      - name: Run Siglens
        run: |
            ./siglens --config server.yaml &
      - name: Get Data
        run: |
            cd tools/clickbench
            wget https://github.com/siglens/pub-datasets/releases/download/test/splithits_trunc_a.tar
            tar -xvf splithits_trunc_a.tar
            rm splithits_trunc_a.tar
            wget https://github.com/siglens/pub-datasets/releases/download/test/splithits_trunc_b.tar
            tar -xvf splithits_trunc_b.tar
            rm splithits_trunc_b.tar
            wget https://github.com/siglens/pub-datasets/releases/download/test/splithits_trunc_c.tar
            tar -xvf splithits_trunc_c.tar
            rm splithits_trunc_c.tar
            python3 send_datamulti.py
            rm splithits_trunc_a splithits_trunc_b splithits_trunc_c
            wget https://github.com/siglens/pub-datasets/releases/download/test/splithits_trunc_d.tar
            tar -xvf splithits_trunc_d.tar
            rm splithits_trunc_d.tar
            wget https://github.com/siglens/pub-datasets/releases/download/test/splithits_trunc_e.tar
            tar -xvf splithits_trunc_e.tar
            rm splithits_trunc_e.tar
            wget https://github.com/siglens/pub-datasets/releases/download/test/splithits_trunc_f.tar
            tar -xvf splithits_trunc_f.tar
            rm splithits_trunc_f.tar
            python3 send_datamulti.py
            rm splithits_trunc_d splithits_trunc_e splithits_trunc_f
            wget https://github.com/siglens/pub-datasets/releases/download/test/splithits_trunc_g.tar
            tar -xvf splithits_trunc_g.tar
            rm splithits_trunc_g.tar
            wget https://github.com/siglens/pub-datasets/releases/download/test/splithits_trunc_h.tar
            tar -xvf splithits_trunc_h.tar
            rm splithits_trunc_h.tar
            wget https://github.com/siglens/pub-datasets/releases/download/test/splithits_trunc_i.tar
            tar -xvf splithits_trunc_i.tar
            rm splithits_trunc_i.tar
            python3 send_datamulti.py
            rm splithits_trunc_g splithits_trunc_h splithits_trunc_i
            wget https://github.com/siglens/pub-datasets/releases/download/test/splithits_trunc_j.tar
            tar -xvf splithits_trunc_j.tar
            rm splithits_trunc_j.tar
            python3 send_datamulti.py
            rm splithits_trunc_j
      - name: Restart Siglens
        run: |
            pkill siglens
            sleep 10
            ./siglens --config server.yaml &
      - name: Run Clickbench Test
        run: |
            sleep 5  # Wait for Siglens to start
            cd tools/sigclient
            go run main.go clickBench -d localhost:5122


